name: "TestFlow"
on:
  [push]
jobs:
  test:
    name: "Test code"
    runs-on: ubuntu-22.04
    environment: "test"
    services:
      db:
        image: mariadb:lts
        ports:
          - 3306
        env:
          MYSQL_ROOT_PASSWORD: ${{ secrets.DB_PASSWORD }}
          MYSQL_DATABASE: ${{ secrets.DB_NAME }}
    steps:
      - name: "Update packages"
        run: "sudo apt update && sudo apt upgrade"

      - name: "Checkout code"
        uses: actions/checkout@v4

      - run: echo "üí° The ${{ github.repository }} repository has been cloned to the runner."

      - name: "Setup php"
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.3"
          extensions: dom, curl, libxml, mbstring, zip, pcntl, pdo, sqlite, pdo_sqlite, bcmath, soap, intl, gd, exif, iconv
          coverage: none

      - name: "Syntax check"
        uses: aglipanci/laravel-pint-action@latest
        with:
          preset: laravel
          testMode: true
          ##CO bude jeste potreba co me napada: migrace, seedy, testy samozrejme, zbuildeni vite, test syntaxe, cron joby

      - name: "Install composer dependencies"
        run: "composer install -n --prefer-dist"

      - name: "Create .env file"
        uses: SpicyPizza/create-envfile@v2.0
        with:
          envkey_DB_CONNECTION: mysql
          envkey_DB_HOST: 127.0.0.1
          envkey_DB_PORT: 3306
          envkey_DB_DATABASE: ${{ secrets.DB_DATABSE }}
          envkey_DB_USERNAME: ${{ secrets.DB_USERNAME }}
          envkey_DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          envkey_APP_NAME: "Ku≈æelna Vesel√≠"
          envkey_APP_ENV: test
          envkey_APP_TIMEZONE: UTC
          envkey_APP_URL: "http://kuzelna_veseli_v2.test"
          envkey_MAIL_MAILER: smtp
          envkey_MAIL_HOST: sandbox.smtp.mailtrap.io
          envkey_MAIL_PORT: 2525
          envkey_MAIL_USERNAME: ${{ secrets.MAIL_USERNAME }}
          envkey_MAIL_PASSWORD: ${{ secrets.MAIL_PASSWORD }}
          envkey_MAIL_FROM_ADDRESS: "info@kuzelnaveseli.cz"
          envkey_MAIL_FROM_NAME: "Ku≈æelna Vesel√≠"

      - name: "Prepare laravel application"
        run: "php artisan key:generate &&
              php artisan migrate --seed &&
              php artisan storage:link"

      - name: "Build assets"
        run: "npm ci npm && run build"

      - name: "Run laravel server"
        run: "php artisan serve"

      - name: "Run tests"
        run:  "php artisan test"

      - name: "Run scheduled tasks"
        run:  "php artisan schedule:run"



